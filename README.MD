# üîç Memory Leak CI Demo Project

–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ –≤ CI/CD pipeline.

## üìñ –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
- ‚úÖ –î–≤–∞ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: —Å —É—Ç–µ—á–∫–∞–º–∏ –ø–∞–º—è—Ç–∏ –∏ –±–µ–∑
- ‚úÖ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —É—Ç–µ—á–µ–∫ (DB connections, cache, file descriptors)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å Pytest + Allure
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (Prometheus + Grafana)
- ‚úÖ –ì–æ—Ç–æ–≤—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å TeamCity CI

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –Ω–∞ Linux VM

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
# –ü–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+
sudo apt update
sudo apt install -y python3 python3-pip python3-venv

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Java (–¥–ª—è Allure)
sudo apt install -y openjdk-11-jdk

# 5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Allure
wget https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
sudo tar -zxvf allure-2.24.1.tgz -C /opt/
sudo ln -s /opt/allure-2.24.1/bin/allure /usr/bin/allure
```

### –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç

```bash
git clone https://github.com/Sermkaym1/memory-leak-ci-demo.git
cd memory-leak-ci-demo
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

```bash
# –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª
cp .env.example .env

# –°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
docker-compose ps
```

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- **App with leak**: http://localhost:5000
- **App without leak**: http://localhost:5001
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (admin/admin)

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã

```bash
# –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫
make test

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
pytest tests/ --alluredir=tests/allure-results -v

# –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç—á–µ—Ç Allure
make report
# –∏–ª–∏
allure serve tests/allure-results
```

### –®–∞–≥ 5: –û—Ç–∫—Ä–æ–π—Ç–µ Grafana –¥–∞—à–±–æ—Ä–¥

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –õ–æ–≥–∏–Ω: `admin`, –ø–∞—Ä–æ–ª—å: `admin`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Dashboards ‚Üí Memory Leak Monitoring
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
memory-leak-ci-demo/
‚îú‚îÄ‚îÄ apps/                           # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ app_with_leak/             # –° —É—Ç–µ—á–∫–∞–º–∏ –ø–∞–º—è—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ app_without_leak/          # –ë–µ–∑ —É—Ç–µ—á–µ–∫
‚îú‚îÄ‚îÄ tests/                         # –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ test_memory_leak.py       # –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã (10-15 –º–∏–Ω)
‚îÇ   ‚îî‚îÄ‚îÄ utils/                    # –£—Ç–∏–ª–∏—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îú‚îÄ‚îÄ monitoring/                    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îÇ   ‚îú‚îÄ‚îÄ prometheus.yml
‚îÇ   ‚îî‚îÄ‚îÄ grafana/                  # –î–∞—à–±–æ—Ä–¥—ã
‚îú‚îÄ‚îÄ ci/                           # CI/CD
‚îÇ   ‚îú‚îÄ‚îÄ teamcity/                 # TeamCity –∫–æ–Ω—Ñ–∏–≥
‚îÇ   ‚îî‚îÄ‚îÄ scripts/                  # –°–∫—Ä–∏–ø—Ç—ã
‚îî‚îÄ‚îÄ docs/                         # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üß™ –¢–∏–ø—ã —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏)

### 1. –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ DB —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```python
# ‚ùå –ü–ª–æ—Ö–æ - —É—Ç–µ—á–∫–∞
conn = psycopg2.connect(...)
# —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è

# ‚úÖ –•–æ—Ä–æ—à–æ
with conn_pool.getconn() as conn:
    # –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    pass
# –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª
```

### 2. –ö–µ—à –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
```python
# ‚ùå –ü–ª–æ—Ö–æ - —É—Ç–µ—á–∫–∞
cache = {}
cache[key] = data  # —Ä–∞—Å—Ç–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

# ‚úÖ –•–æ—Ä–æ—à–æ
from cachetools import TTLCache
cache = TTLCache(maxsize=100, ttl=300)
```

### 3. –§–∞–π–ª–æ–≤—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã
```python
# ‚ùå –ü–ª–æ—Ö–æ - —É—Ç–µ—á–∫–∞
f = open('file.txt', 'w')
f.write(data)
# f.close() - –∑–∞–±—ã–ª–∏!

# ‚úÖ –•–æ—Ä–æ—à–æ
with open('file.txt', 'w') as f:
    f.write(data)
# –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä–æ–µ—Ç—Å—è
```

## üìà –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–µ—Å—Ç—ã

```python
# tests/test_memory_leak.py

@pytest.mark.allure.severity('critical')
@pytest.mark.parametrize('duration', [600, 900])  # 10 –∏ 15 –º–∏–Ω—É—Ç
def test_detect_memory_leak(app_container, duration):
    """
    1. –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É (HTTP –∑–∞–ø—Ä–æ—Å—ã)
    3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø–∞–º—è—Ç—å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    4. –°—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –≤ Allure
    5. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ—Å—Ç—å –ª–∏ —É—Ç–µ—á–∫–∞
    """
    pass
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Ç–µ—á–∫–∏:

- **–†–æ—Å—Ç –ø–∞–º—è—Ç–∏** > 50 MB –∑–∞ —Ç–µ—Å—Ç
- **–¢—Ä–µ–Ω–¥**: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞—Å—Ç—É—â–∏–π (–Ω–µ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è)
- **–°–∫–æ—Ä–æ—Å—Ç—å —Ä–æ—Å—Ç–∞** > 5 MB/–º–∏–Ω

## üéØ Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make help          # –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
make build         # –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã
make up            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make down          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make test          # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
make report        # –û—Ç–∫—Ä—ã—Ç—å Allure –æ—Ç—á–µ—Ç
make clean         # –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
make logs          # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
```

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TeamCity

–°–º. [ci/teamcity/README.md](ci/teamcity/README.md)

–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ TeamCity
2. –î–æ–±–∞–≤—å—Ç–µ VCS root (—ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ci/teamcity/settings.kts` –∫–∞–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Allure –ø–ª–∞–≥–∏–Ω
5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ build

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [MEMORY_LEAK_PATTERNS.md](docs/MEMORY_LEAK_PATTERNS.md) - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —É—Ç–µ—á–µ–∫
- [QUICK_START.md](docs/QUICK_START.md) - –ü–æ–¥—Ä–æ–±–Ω—ã–π Quick Start

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker-compose logs app-with-leak

# –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑—ã
docker-compose build --no-cache
```

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã
docker-compose ps

# –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
sleep 30
pytest tests/
```

### –ü—Ä–æ–±–ª–µ–º–∞: Allure –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∏
```bash
# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Allure
sudo rm -rf /opt/allure-*
# –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ Quick Start
```

