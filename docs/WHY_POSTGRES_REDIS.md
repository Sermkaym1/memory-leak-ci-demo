# ü§î –ó–∞—á–µ–º –Ω—É–∂–Ω—ã PostgreSQL –∏ Redis?

## üìã **–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:**

PostgreSQL –∏ Redis –Ω—É–∂–Ω—ã –¥–ª—è **—Å–æ–∑–¥–∞–Ω–∏—è –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–• —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏**, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.

---

## üéØ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:**

### 1. **PostgreSQL - –¥–ª—è —É—Ç–µ—á–µ–∫ DB —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –º–∏—Ä–µ:**
```python
# ‚ùå –ü–ª–æ—Ö–æ–π –∫–æ–¥ (–£–¢–ï–ß–ö–ê)
def get_user_data():
    conn = psycopg2.connect("postgresql://...")
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users")
    data = cursor.fetchall()
    # –ó–ê–ë–´–õ–ò –ó–ê–ö–†–´–¢–¨: conn.close()
    return data
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ù–ï –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è (`conn.close()` –∑–∞–±—ã–ª–∏)
- –ù–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ü–∞–º—è—Ç—å —Ä–∞—Å—Ç–µ—Ç, –ë–î –º–æ–∂–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –Ω–æ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö

**–ö–∞–∫ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ:**
```python
# apps/app_with_leak/app.py - —Å—Ç—Ä–æ–∫–∞ 78
@app.route('/api/database')
def database_query():
    # ‚ùå –£–¢–ï–ß–ö–ê: –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
    conn = psycopg2.connect(...)
    DB_CONNECTIONS.append(conn)  # –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –≤ —Å–ø–∏—Å–∫–µ
    # conn.close() <- –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ!
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±:**
```python
# apps/app_without_leak/app.py
# ‚úÖ Connection Pool - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
DB_POOL = psycopg2.pool.SimpleConnectionPool(minconn=1, maxconn=10, ...)

def database_query():
    conn = DB_POOL.getconn()  # –ë–µ—Ä–µ–º –∏–∑ –ø—É–ª–∞
    try:
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        pass
    finally:
        DB_POOL.putconn(conn)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø—É–ª
```

---

### 2. **Redis - –¥–ª—è —É—Ç–µ—á–µ–∫ connection pool**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –º–∏—Ä–µ:**
```python
# ‚ùå –ü–ª–æ—Ö–æ–π –∫–æ–¥ (–£–¢–ï–ß–ö–ê)
def cache_data(key, value):
    # –ö–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–µ–º –ù–û–í–´–ô –∫–ª–∏–µ–Ω—Ç
    redis_client = redis.Redis(host='redis')
    redis_client.set(key, value)
    # –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º connection pool!
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- Redis –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π connection pool
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑ - –ø—É–ª –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –ù–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ Redis
- –ü–∞–º—è—Ç—å –∏ —Ñ–∞–π–ª–æ–≤—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã —Ä–∞—Å—Ç—É—Ç

**–ö–∞–∫ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ:**
```python
# apps/app_with_leak/app.py - —Å—Ç—Ä–æ–∫–∞ 123
@app.route('/api/redis')
def redis_cache():
    # ‚ùå –£–¢–ï–ß–ö–ê: –ö–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
    r = redis.Redis(host=os.getenv('REDIS_HOST', 'redis'))
    # –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º connection pool!
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±:**
```python
# apps/app_without_leak/app.py
# ‚úÖ Singleton client - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç
REDIS_CLIENT = None

def get_redis_client():
    global REDIS_CLIENT
    if REDIS_CLIENT is None:
        REDIS_CLIENT = redis.Redis(
            connection_pool=redis.ConnectionPool(max_connections=10)
        )
    return REDIS_CLIENT
```

---

## üß™ **–ö–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–µ—Å—Ç—ã:**

### **–¢–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –° —É—Ç–µ—á–∫–æ–π:**
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/database` –∏ `/api/redis`
2. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
3. –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ù–ï –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è
4. –ü–∞–º—è—Ç—å —Ä–∞—Å—Ç–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ ‚Üí **–£–¢–ï–ß–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê** ‚úÖ

### **–¢–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ë–ï–ó —É—Ç–µ—á–∫–∏:**
1. –¢–µ –∂–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –∏ Redis
2. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è connection pools
3. –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
4. –ü–∞–º—è—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–∞ ‚Üí **–£—Ç–µ—á–∫–∏ –ù–ï–¢** ‚úÖ

---

## üí° **–ú–æ–∂–Ω–æ –ª–∏ –±–µ–∑ –Ω–∏—Ö?**

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ - –î–ê**, –Ω–æ —Ç–æ–≥–¥–∞:

‚ùå **–£—Ç–µ—á–∫–∏ –±—É–¥—É—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º–∏:**
```python
# –ü—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –º–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏
big_list = []
for i in range(10000):
    big_list.append("x" * 1000)  # –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏
```

‚úÖ **–° PostgreSQL + Redis —É—Ç–µ—á–∫–∏ –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ï:**
- –¢–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –¢–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–∏–º—ã –∫ —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º

---

## üöÄ **–†–µ–∑—é–º–µ:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ó–∞—á–µ–º –Ω—É–∂–µ–Ω | –ö–∞–∫—É—é —É—Ç–µ—á–∫—É –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç |
|-----------|-------------|----------------------------|
| **PostgreSQL** | –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ DB –∑–∞–ø—Ä–æ—Å—ã | –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ë–î |
| **Redis** | –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | Connection pool —É—Ç–µ—á–∫–∏ |
| **Flask App** | HTTP API endpoints | –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö —É—Ç–µ—á–µ–∫ |

**–ò—Ç–æ–≥:** PostgreSQL –∏ Redis –¥–µ–ª–∞—é—Ç –¥–µ–º–æ **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–º –∫ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏** –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –≤ production-–∫–æ–¥–µ.