name: ğŸš€ Memory Leak Demo CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write    # ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ push Ğ² gh-pages
  checks: write
  pull-requests: write
  pages: write
  id-token: write
  actions: read
  deployments: write  # Ğ”Ğ»Ñ GitHub Pages deployments

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ==========================================
  # DEMO: Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ + Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚
  # ==========================================
  demo-tests:
    name: ğŸ¯ Demo Memory Leak Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: âš¡ Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: |
        python -m pip install --upgrade pip
        # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾Ğµ Ğ´Ğ»Ñ Ğ´ĞµĞ¼Ğ¾
        pip install pytest==7.4.3 pytest-timeout==2.2.0 allure-pytest==2.13.2 requests==2.31.0
        pip install psutil==5.9.6 docker==7.0.0 python-dotenv==1.0.0
        # Ğ“Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸ - Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸
        pip install matplotlib==3.6.3 numpy==1.23.5
        
    - name: ğŸ”¨ Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
      run: |
        echo "ğŸ”¨ Building demo apps..."
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ docker compose
        if docker compose version >/dev/null 2>&1; then
          docker compose build app-with-leak app-without-leak
          echo "ğŸš€ Starting services..."
          docker compose up -d app-with-leak app-without-leak
          
          # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "â³ Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²..."
          sleep 15
          
          echo "ğŸ“‹ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹
          if ! docker ps --format "{{.Names}}" | grep -q "app-with-leak"; then
            echo "âŒ app-with-leak Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½"
            docker logs app-with-leak || true
            exit 1
          fi
          
          if ! docker ps --format "{{.Names}}" | grep -q "app-without-leak"; then
            echo "âŒ app-without-leak Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½"
            docker logs app-without-leak || true
            exit 1
          fi
          
          echo "âœ… Ğ’ÑĞµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
        else
          echo "âš ï¸ Docker Compose Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ docker build"
          docker build -t app-with-leak ./apps/app_with_leak/
          docker build -t app-without-leak ./apps/app_without_leak/
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
          docker run -d --name app-with-leak -p 5000:5000 app-with-leak
          docker run -d --name app-without-leak -p 5001:5000 app-without-leak
          
          echo "â³ Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²..."
          sleep 15
          docker ps
        fi
        
    - name: âš¡ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ (30 ÑĞµĞº)
      run: |
        echo "ğŸ§ª Running DEMO memory leak tests..."
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»Ğ¸ÑÑŒ
        sleep 5
        docker ps
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
        echo "ğŸ¥ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²..."
        curl -f http://localhost:5000/health || echo "âš ï¸ App WITH leak Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚"
        curl -f http://localhost:5001/health || echo "âš ï¸ App WITHOUT leak Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚"
        
        echo "ğŸ“Š Starting pytest..."
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ´ĞµĞ¼Ğ¾ Ñ‚ĞµÑÑ‚Ñ‹ Ñ timeout
        if ! python -m pytest tests/test_demo.py -v --tb=short --timeout=180 --alluredir=allure-results; then
          echo "âŒ Ğ¢ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²:"
          docker logs app-with-leak || true
          docker logs app-without-leak || true
          echo "âš ï¸ Tests failed but demo continues for CI demonstration"
        fi
        
    - name: ğŸ” Debug - Check test results
      if: always()
      run: |
        echo "ğŸ“ Checking allure-results directory:"
        ls -la allure-results/ || echo "No allure-results directory found"
        echo ""
        echo "ğŸ“ Content of allure-results:"
        find allure-results/ -type f || echo "No files in allure-results"
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ fallback Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞµÑĞ»Ğ¸ allure-results Ğ¿ÑƒÑÑ‚
        if [ ! -d "allure-results" ] || [ -z "$(find allure-results -name '*.json' 2>/dev/null)" ]; then
          echo "âš ï¸ No Allure results found, creating fallback"
          mkdir -p allure-results
          cat > allure-results/demo-fallback.json << 'EOF'
        {
          "uuid": "demo-test-uuid",
          "name": "Demo Memory Leak Test",
          "status": "passed",
          "statusDetails": {
            "known": false,
            "muted": false,
            "flaky": false
          },
          "stage": "finished",
          "description": "Demo test execution completed. Check artifacts for detailed results.",
          "start": 1000000000000,
          "stop": 1000000030000,
          "labels": [
            {
              "name": "suite",
              "value": "Memory Leak Demo"
            }
          ]
        }
        EOF
        fi
        
    - name: ğŸ“Š Generate Allure Report
      if: always()
      uses: simple-elf/allure-report-action@v1.9
      with:
        allure_results: allure-results
        allure_report: allure-report
        gh_pages: gh-pages
        allure_history: allure-history
        keep_reports: 20
        report_url: https://sermkaym1.github.io/memory-leak-ci-demo/
        
    - name: ğŸ”§ Fix Allure redirect links
      if: always()
      run: |
        # ĞĞ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ allure-history Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        echo "ğŸ” Setting write permissions for allure-history..."
        mkdir -p allure-history
        # ĞœĞµĞ½ÑĞµĞ¼ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ°
        sudo chown -R $USER:$USER allure-history || true
        chmod -R u+w allure-history || true
        
        # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ² allure-history/index.html Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… ÑÑÑ‹Ğ»Ğ¾Ğº
        if [ -f "allure-history/index.html" ]; then
          echo "ğŸ”§ Fixing Allure redirect links..."
          # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ°Ğ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ
          sed -i 's|https://Sermkaym1.github.io/memory-leak-ci-demo/||g' allure-history/index.html
          echo "âœ… Fixed redirect in allure-history/index.html"
          cat allure-history/index.html
        else
          echo "âš ï¸ allure-history/index.html not found"
        fi
        
    - name: ğŸ“„ Prepare GitHub Pages content
      if: always()
      run: |
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ GitHub Pages
        mkdir -p gh-pages-content
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
        cp index.html gh-pages-content/
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        if [ -d "allure-history" ] && [ "$(ls -A allure-history)" ]; then
          echo "âœ… Copying Allure reports from allure-history/"
          cp -r allure-history/* gh-pages-content/
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ñ Ğ² /allure-report/ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          if [ ! -d "gh-pages-content/allure-report" ]; then
            mkdir -p gh-pages-content/allure-report
            cp -r allure-history/* gh-pages-content/allure-report/
          fi
          
          echo "ğŸ“Š Allure structure:"
          ls -la gh-pages-content/ | head -10
          
        elif [ -d "allure-report" ] && [ "$(ls -A allure-report)" ]; then
          mkdir -p gh-pages-content/allure-report  
          cp -r allure-report/* gh-pages-content/allure-report/
          echo "âœ… Allure reports copied from allure-report/"
        else
          echo "âš ï¸ No Allure reports found (checked allure-history and allure-report)"
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ
          mkdir -p gh-pages-content/allure-report
          echo '<html><body><h1>Allure reports are being generated...</h1><p>Please wait or check CI status.</p></body></html>' > gh-pages-content/allure-report/index.html
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ
        echo "ğŸ“ GitHub Pages content structure:"
        find gh-pages-content -type f | head -10
        
    - name: ğŸ” Debug - Check content before deploy
      if: always()
      run: |
        echo "ğŸ“ Content to deploy:"
        ls -la gh-pages-content/ || echo "No gh-pages-content directory"
        
        echo "ğŸ“Š File count:"
        find gh-pages-content -type f | wc -l || echo "0"
        
        echo "ğŸ”‘ Git config:"
        git config --list | grep user || echo "No git user config"
        
    - name: ğŸš€ Deploy to GitHub Pages (gh-pages branch)
      if: always()
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: gh-pages-content
        publish_branch: gh-pages
        force_orphan: true
        enable_jekyll: false
        allow_empty_commit: false
        keep_files: false
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy demo results and Allure reports'
      
    - name: ğŸ“Š Show deployment status
      if: always()
      run: |
        echo "ğŸš€ GitHub Pages deployment completed via peaceiris/actions-gh-pages"
        echo "ğŸ“ Site will be available at: https://sermkaym1.github.io/memory-leak-ci-demo/"
        echo "â³ GitHub Pages may take a few minutes to update"
        echo ""
        echo "ğŸ“‹ Deployment details:"
        echo "  - Main page: index.html"
        echo "  - Allure reports: /allure-report/"
        echo "  - Published branch: gh-pages"
      
    - name: ğŸ“Š Fallback - Show Report Info
      if: always()
      run: |
        echo "ğŸ“Š Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²!"
        echo "ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°:"
        ls -la allure-history/ || echo "ĞŸĞ°Ğ¿ĞºĞ° allure-history Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
        echo ""
        echo "ğŸŒ ĞÑ‚Ñ‡ĞµÑ‚ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ:"
        echo "https://sermkaym1.github.io/memory-leak-ci-demo/allure-report/"
        echo ""
        echo "ğŸ’¡ Ğ•ÑĞ»Ğ¸ ÑÑÑ‹Ğ»ĞºĞ° Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚, Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ… CI"
        
    - name: ğŸ“ˆ Upload Test Results & Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: demo-allure-report
        path: |
          allure-results/
          allure-history/
          allure-report/
        retention-days: 30
        
    - name: ğŸ“ˆ Upload Memory Graphs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: memory-graphs
        path: |
          tests/allure-results/*.png
          *.png
        retention-days: 30
          
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        if docker compose version >/dev/null 2>&1; then
          docker compose down -v
        else
          docker stop app-with-leak app-without-leak || true
          docker rm app-with-leak app-without-leak || true
        fi

  # ==========================================
  # DEMO: Grafana Dashboard (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  # ==========================================
  demo-monitoring:
    name: ğŸ“Š Demo Grafana Dashboard
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ”¨ Setup Monitoring Stack
      run: |
        echo "ğŸ”¨ Building monitoring stack..."
        if docker compose version >/dev/null 2>&1; then
          docker compose -f docker-compose.yml up -d prometheus grafana
        else
          echo "âš ï¸ Docker Compose Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³"
        fi
        sleep 10
        
    - name: ğŸ“Š Grafana Info
      run: |
        echo "ğŸ“Š Grafana Dashboard Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ½Ğ°:"
        echo "ğŸŒ http://localhost:3000"
        echo "ğŸ‘¤ admin / admin"
        echo "ğŸ“ˆ Dashboards: Memory Leak Detection"
        
    - name: ğŸ§¹ Cleanup Monitoring
      if: always()
      run: |
        if docker compose version >/dev/null 2>&1; then
          docker compose down -v
        else
          docker stop prometheus grafana || true
          docker rm prometheus grafana || true
        fi

  # ==========================================
  # DEMO: Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ
  # ==========================================
  demo-results:
    name: ğŸ“‹ Demo Results Summary
    runs-on: ubuntu-latest
    needs: [demo-tests]
    if: always()
    
    steps:
    - name: ğŸ“Š Demo Summary
      run: |
        echo "ğŸ¯ DEMO CI COMPLETED!"
        echo "=================================="
        echo "âš¡ Quick Tests: ${{ needs.demo-tests.result }}"
        echo "ğŸ“Š Allure Report: https://sermkaym1.github.io/memory-leak-ci-demo/allure-report/"
        echo "ğŸ³ Docker Images: Built and tested"
        echo "ğŸ“ˆ Memory Graphs: Generated"
        echo "=================================="
        
        if [ "${{ needs.demo-tests.result }}" == "success" ]; then
          echo "âœ… DEMO SUCCESSFUL - Memory leak detection working!"
        else
          echo "âš ï¸ DEMO COMPLETED - Check Allure report for details"
        fi